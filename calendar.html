<!DOCTYPE html>
<html>

<head>
    <title>print · calendar</title>

    <script>
        window.addEventListener("load", (e) => {
            formatTable(1, 1, 13, false, 0, false);

            const form = document.querySelector("form");
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                parseForm(e.target);
            });
        });

        function formatTable(initialDay, initialMonth, weeks, initialAlt, hiddenWeeks, isLeap) {
            const headers = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
            const monthLengths = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            if (isLeap) monthLengths[1] = 29;

            const table = document.querySelector("table");
            table.innerHTML = "";
            populateTableHead(table, headers);
            populateTableBody(table, headers.length, monthLengths, initialDay, initialMonth, weeks, initialAlt, hiddenWeeks, isLeap);
        }

        function populateTableHead(table, headers) {
            const thead = document.createElement("thead");
            const tr = document.createElement("tr");
            thead.appendChild(tr);

            for (let i = 0; i < headers.length; i++) {
                const th = document.createElement("th");
                th.appendChild(document.createTextNode(headers[i]));
                tr.appendChild(th);
            }

            table.appendChild(thead);
        }

        function populateTableBody(table, weekLength, monthLengths, initialDay, initialMonth, weeks, initialAlt, hiddenWeeks, isLeap) {
            const tbody = document.createElement("tbody");

            let d = initialDay;
            let m = initialMonth;
            let alt = initialAlt;

            for (let week = weeks; week > 0; week--) {
                const tr = document.createElement("tr");
                if (week <= hiddenWeeks) { tr.classList.add("invisible"); }
                
                for (let day = 0; day < weekLength; day++) {
                    const td = document.createElement("td");
                    td.classList.add(`m${m}`);
                    td.innerText = d;
                    if (alt) { td.classList.add("alt"); }

                    d++;
                    if (d > monthLengths[m-1]) {
                        d = 1;
                        m++;
                        if (m > monthLengths.length) {
                            m = 1;
                        }
                        alt = !alt;
                    }

                    tr.appendChild(td);
                }

                tbody.appendChild(tr);
            }

            table.appendChild(tbody);
        }

        function parseForm(form) {
            const initial = form.querySelector("input#initialWeek")?.value;
            const weeks = Number(form.querySelector("input#weeks")?.value);
            const hiddenWeeks = Number(form.querySelector("input#hiddenWeeks")?.value);
            const initialAlt = Boolean(form.querySelector("input#initialAlt")?.checked);
            
            const date = initial ? parseWeekString(initial) : new Date(Date.now());
            const day = date.getDate();
            const month = date.getMonth()+1;
            // console.log(`${day}/${month} | ${date}`);

            // https://stackoverflow.com/questions/8175521/javascript-to-find-leap-year/8175905#8175905
            const isLeap = (month > 2) ?
                new Date(date.getFullYear()+1, 1, 29).getMonth() == 1 :
                new Date(date.getFullYear(), 1, 29).getMonth() == 1

            formatTable(day, month, weeks, initialAlt, hiddenWeeks, isLeap);
        }

        // https://stackoverflow.com/questions/72957624/convert-a-week-number-and-year-to-a-date-object-in-javascript/72961100#72961100
        function parseWeekString(str) {
            const [year, week] = str.split("-W");
            // Get date of January 4th for specified year
            // > First week of the year is the week that contains the first Thursday of the year (weeks begin on Monday); ∴ 4th
            // https://developer.mozilla.org/en-US/docs/Web/HTML/Date_and_time_formats#week_strings
            const date = new Date(year, 0, 4);
            // Get previous Monday, add 7 days for each week after first
            date.setDate(date.getDate() - (date.getDay() || 7) + 1 + (week - 1) * 7);

            return date;
        }
    </script>

    <style>
        @font-face {
            font-family: Midnight;
            src: url(Blackout-Midnight.ttf);
        }

        @font-face {
            font-family: Rubik;
            src: url(Rubik-Bold.ttf);
        }

        @font-face {
            font-family: MaShanZheng;
            src: url(MaShanZheng-Regular.ttf);
        }

        @page {
            margin: 0;
            size: A4 portrait;
        }

        :root {
            --body-color: #5F6368;
            --page-color: #FFFFFF;
            --text-color: #000000;
            --alt-color: #EFEFEF;
        }

        body {
            background-color: var(--body-color);
            margin: 0;
        }

        .page {
            background-color: var(--page-color);
            /* DIN A4 standard paper size */
            height: 297mm;
            width: 210mm;
            /* Layout */
            box-sizing: border-box;
            padding: 10mm 10mm;
            margin: auto;
        }

        table {
            width: 100%;
            height: 100%;
            /* Center horizontally */
            margin: 0 auto;

            font-family: Rubik;
        }

        table, th, td {
            border-collapse: collapse;
            border: 1px solid var(--text-color);
        }

        th, td {
            width: calc(100% / 7);
        }

        th {
            font-family: Midnight;
            font-size: 24pt;
            color: var(--page-color);
            background-color: var(--text-color);
            padding: 1.25% 0%;
        }

        td {
            font-size: 10pt;
            padding: 0.1em 0.25em;
            vertical-align: text-top;
            position: relative;
        }

        tr.invisible, .invisible td {
            visibility: hidden;
            border: none;
        }

        td.alt { background-color: var(--alt-color); }
        td.alt::after { color: var(--page-color); }

        td::after {
            color: var(--alt-color);
            text-align: center;
            font-family: MaShanZheng;
            font-size: 44pt;
            /* Center */
            position: absolute;
            left: 0;
            width: 100%;
            height: 100%;
            line-height: 75px;
        }

        td.m1::after  { content: "一"; }
        td.m2::after  { content: "二"; }
        td.m3::after  { content: "三"; }
        td.m4::after  { content: "四"; }
        td.m5::after  { content: "五"; }
        td.m6::after  { content: "六"; }
        td.m7::after  { content: "七"; }
        td.m8::after  { content: "八"; }
        td.m9::after  { content: "九"; }
        td.m10::after { content: "十"; }
        td.m11::after { content: "十一"; font-size: 36pt; }
        td.m12::after { content: "十二"; font-size: 36pt; }
    </style>

    <style>
        @media print {
            form { display: none; }
        }

        form {
            position: fixed;
            top: 0.5em;
            right: 0.5em;
            
            background-color: var(--alt-color);
            border-radius: 0.5em;
            border: 1px dashed var(--text-color);
        }

        form ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        form label {
            display: inline-block;
            text-align: right;
            width: 6em;
            font-style: italic;
        }

        form input {
            box-sizing: border-box;
            width: 10em;
        }

        form input[type="checkbox"] {
            margin: 0.2em 0;
            width: 1em;
        }

        form button {
            margin-left: 7.5em;
        }
    </style>
</head>

<body>
    <div class="page">
        <table>
        </table>
    </div>

    <form>
        <ul>
            <li>
                <label for="initialWeek">Initial week:</label>
                <input id="initialWeek" name="initialWeek" type="week" />
            </li>
            <li>
                <label for="weeks">Weeks:</label>
                <input id="weeks" name="weeks" type="number" value="13" min="0" max="15" />
            </li>
            <li>
                <label for="hiddenWeeks">Hidden weeks:</label>
                <input id="hiddenWeeks" name="hiddenWeeks" type="number" value="0" />
            </li>
            <li>
                <label for="initialAlt">Initial alt:</label>
                <input id="initialAlt" name="initialAlt" type="checkbox" value="1" />
            </li>

            <li>
                <button type="submit">Render</button>
            </li>
        </ul>
    </form>
</body>

</html>